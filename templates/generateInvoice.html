{% extends 'base.html' %}
{% load static %}

{% block title %}
    New Invoice
{% endblock %}

{% block body %}
<div class="card">
    <h2>Generate New Invoice</h2>

    <form method="post" id="invoice-form">
        {% csrf_token %}

        <div style="display: flex; gap: 2px; margin-bottom: 1rem;">
            <div style="flex:1;">

                <div class="form-field">
                    {{ invoiceForm.userId.label_tag }}
                    {{ invoiceForm.userId }}
                </div>
                
                <div class="form-field">
                    {{ invoiceForm.buyerId.label_tag }}
                    {{ invoiceForm.buyerId }}
                </div>

                <div class="form-field">
                    {{ invoiceForm.invNum.label_tag }}
                    {{ invoiceForm.invNum }}
                </div>

                <div class="form-field">
                    {{ invoiceForm.date.label_tag }}
                    {{ invoiceForm.date }}
                </div>
                
                

                {# Display invoiceForm's non-field errors #}
                {% if invoiceForm.non_field_errors %}
                    <div class="form-error-card">
                        {% for error in invoiceForm.non_field_errors %}
                            <div class="error">{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endif %}

                {# Field-level errors #}
                {% for field in invoiceForm %}
                    {% if field.errors %}
                        <div class="error">{{ field.label }}: {{ field.errors.0 }}</div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <h3 style="margin-top: 1rem;">Invoice Items</h3>

        {{ itemFormSet.management_form }}

        {% if itemFormSet.non_form_errors %}
            <div class="form-error-card">
                {% for error in itemFormSet.non_form_errors %}
                    <div class="error">{{ error }}</div>
                {% endfor %}
            </div>
        {% endif %}

        <div class="form-table-container">
            <table class="form-table" id="item-table">
                <thead>
                    <tr>
                        <th style="width: 50%;">{{ itemFormSet.empty_form.itemName.label }}</th>
                        <th style="width: 15%;">{{ itemFormSet.empty_form.rate.label }}</th>
                        <th style="width: 15%;">{{ itemFormSet.empty_form.gst.label }}</th>
                        <th style="width: 15%;">{{ itemFormSet.empty_form.qty.label }}</th>
                        <th style="width: 5%;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for itemForm in itemFormSet %}
                    <tr class="item-row">
                        <td style="width: 50%;">
                            <div class="form-field">
                                {{ itemForm.itemName }}
                            </div>
                        </td>
                        <td style="width: 15%;">
                            <div class="form-field">
                                {{ itemForm.rate }}
                            </div>
                        </td>
                        <td style="width: 15%;">
                            <div class="form-field">
                                {{ itemForm.gst }}
                            </div>
                        </td>
                        <td style="width: 15%;">
                            <div class="form-field">
                                {{ itemForm.qty }}
                            </div>
                        </td>
                        <td style="width: 5%; min-width: 3.2rem">
                          -
                        </td>
                    </tr>

                    {% if itemForm.errors %}
                    <tr>
                        <td colspan="5">
                            <div class="form-error-card">
                                <ul>
                                    {% for field_name, errors in itemForm.errors.items %}
                                        <li><strong>{{ field_name }}:</strong>
                                            {% for error in errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </li>
                                    {% endfor %}
                                    {% if itemForm.non_field_errors %}
                                        {% for error in itemForm.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}

                    <tr id="empty-form-template" style="display: none;">
                        <td style="width: 50%;"><div class="form-field">{{ itemFormSet.empty_form.itemName }}</div></td>
                        <td style="width: 15%;"><div class="form-field">{{ itemFormSet.empty_form.rate }}</div></td>
                        <td style="width: 15%;"><div class="form-field">{{ itemFormSet.empty_form.gst }}</div></td>
                        <td style="width: 15%;"><div class="form-field">{{ itemFormSet.empty_form.qty }}</div></td>
                        <td style="width: 5%;">
                          <button type="button" class="btn-destructive remove-row-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="1.2rem" height="1.2rem" viewBox="0 0 24 24"><path fill="currentColor" d="M2 17a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5h-2v5H4v-5H2m12.12-6.54l1.42 1.42L13.41 9l2.13 2.12l-1.42 1.42L12 10.41l-2.12 2.13l-1.42-1.42L10.59 9L8.46 6.88l1.42-1.42L12 7.59Z"/></svg>
                          </button>
                         </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div style="margin-top: 1rem;">
            <button type="button" id="add-item-button" class="btn-secondary">Add New Item</button>
        </div>

        <div class="totals" style="text-align: right; margin-top: 2rem; font-weight: 500;">
            <p>Subtotal: <span id="subtotal-display">{{ invoiceInst.subTotal|default:"0.00" }}</span></p>
            <p>Total GST: <span id="gst-total-display">{{ invoiceInst.gstTotal|default:"0.00" }}</span></p>
            <p>Grand Total: <span id="grand-total-display">{{ invoiceInst.grandTotal|default:"0.00" }}</span></p>
        </div>
        
        <div style="margin-top: 1.5rem; display: flex; justify-content: center;">
            <button type="submit" class="btn-primary" style="width: 100%;">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    style="margin: 0 5px 0 0;"
                    width="1.2rem"
                    height="1.2rem"
                    viewBox="0 0 24 24"
                >
                    <path
                        fill="currentColor"
                        d="M5 21q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h6v2H5v14h14v-6h2v6q0 .825-.587 1.413T19 21zm11-10V8h-3V6h3V3h2v3h3v2h-3v3z"
                    />
                </svg>
                Generate
            </button>
        </div>
    </form>
</div>

<script>
    const FORMSET_PREFIX = "{{ itemFormSet.prefix }}";
    const IS_EDIT_PAGE = false;
</script>
<script src="{% static 'script.js' %}" defer></script>
{% endblock %}