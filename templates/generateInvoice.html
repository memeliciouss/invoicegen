{% extends 'base.html' %}
{% load static %}
{% block title %}
    New Invoice
{% endblock %}

{% block body %}
    <h1>Generate new Invoice</h1>
    <form method="post" id="invoice-form"> {# Added an ID to the form for easier selection #}
        {% csrf_token %}

        <h2>Invoice Details</h2>
        {{ invoiceForm.as_p }}

        {# Display invoiceForm's non-field errors #}
        {% if invoiceForm.non_field_errors %}
            <ul>
                {% for error in invoiceForm.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        {# Display invoiceForm's field-specific errors #}
        {% for field in invoiceForm %}
            {% if field.errors %}
                <ul>
                    {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endfor %}


        <h2>Invoice Items</h2>
        {# CRITICAL: This renders hidden fields required by the formset #}
        {{ itemFormSet.management_form }}

        {# Display formset-level non-field errors #}
        {% if itemFormSet.non_form_errors %}
            <ul>
                {% for error in itemFormSet.non_form_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <table id="item-table"> {# Added an ID to the table for easier selection #}
            <thead>
                <tr>
                    <th>
                        {{ itemFormSet.empty_form.itemName.label }}
                    </th>
                    <th>
                        {{ itemFormSet.empty_form.rate.label }}
                    </th>
                    <th>
                        {{ itemFormSet.empty_form.gst.label }}
                    </th>
                    <th>
                        {{ itemFormSet.empty_form.qty.label }}
                    </th>
                    <th>Action</th> {# New column for the remove button #}
                </tr>
            </thead>
            <tbody>
                {% for itemForm in itemFormSet %}
                    <tr class="item-row"> {# Added class for easier selection #}
                        <td>
                            {{ itemForm.itemName }}
                        </td>
                        <td>
                            {{ itemForm.rate }}
                        </td>
                        <td>
                            {{ itemForm.gst }}
                        </td>
                        <td>
                            {{ itemForm.qty }}
                        </td>
                        <td>
                            <button type="button" class="remove-row-button">Remove</button> {# Remove button #}
                        </td>
                    </tr>
                    {# Display errors for the current individual item form #}
                    {% if itemForm.errors %}
                        <tr>
                            <td colspan="5"> {# Changed colspan to 5 due to new 'Action' column #}
                                <ul>
                                    {% for field_name, errors in itemForm.errors.items %}
                                        <li><strong>{{ field_name }}:</strong>
                                            {% for error in errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </li>
                                    {% endfor %}
                                    {% if itemForm.non_field_errors %}
                                        {% for error in itemForm.non_field_errors %}
                                            <li>{{ error }}</li>
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                            </td>
                        </tr>
                    {% endif %}
                {% endfor %}
                {# This hidden row will serve as our template for new rows #}
                <tr id="empty-form-template" style="display: none;">
                    <td>{{ itemFormSet.empty_form.itemName }}</td>
                    <td>{{ itemFormSet.empty_form.rate }}</td>
                    <td>{{ itemFormSet.empty_form.gst }}</td>
                    <td>{{ itemFormSet.empty_form.qty }}</td>
                    <td><button type="button" class="remove-row-button">Remove</button></td>
                </tr>
            </tbody>
        </table>

        <button type="button" id="add-item-button">Add new Item</button> {# Changed type to button and added ID #}
        <button type="submit">Generate</button>
    </form>
<script>
    const FORMSET_PREFIX = "{{ itemFormSet.prefix }}";
    const IS_EDIT_PAGE = false;
</script>
<script src="{% static 'script.js' %}" defer></script>
{% endblock %}