{% extends 'base.html' %}
{% load static %}
{% block title %}
Edit Invoice {{ invoiceInst.invNum }}
{% endblock %}

{% block body %}
<div class="card">
  <h2>Edit Invoice</h2>

  <form method="post">
    {% csrf_token %}

    <div style="display: flex; gap: 2px; margin-bottom: 1rem;">

      <div style="flex:1;">
        <div class="form-field" style="gap:1px">
          <label>Buyer:</label>
          <p>{{ invoiceInst.buyerId.name }}</p>
          <p>GSTIN: {{ invoiceInst.buyerId.gstin }}</p>
          <p>{{ invoiceInst.buyerId.adr1 }}</p>
          <p>{{ invoiceInst.buyerId.adr2 }}</p>
          <p>{{ invoiceInst.buyerId.state }}, {{ invoiceInst.buyerId.pin }}</p>
        </div>
      </div>

            <div style="flex:1;">
        <div class="form-field">
          <label>Invoice Number: </label>
          <p>{{invoiceForm.invNum}}</p>
        </div>

        <div class="form-field" style="width: 80%;">
          {{ invoiceForm.date.label_tag }}
          {{ invoiceForm.date }}
          {% if invoiceForm.date.errors %}
            <div class="error">{{ invoiceForm.date.errors.0 }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    {{ itemFormSet.management_form }}

    {% if itemFormSet.non_form_errors %}
      <div class="form-error-card">
        {% for err in itemFormSet.non_form_errors %}
          <div class="error">{{ err }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="form-table-container">
      <table class="form-table" id="item-table">
        <thead>
          <tr>
            <th style="width: 50%;">Item Name</th>
            <th style="width: 15%;">Rate</th>
            <th style="width: 15%;">GST %</th>
            <th style="width: 15%;">Quantity</th>
            <th style="width: 5%;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for itemForm in itemFormSet %}
          <tr class="item-row">
            <td style="width: 50%;">
              <div class="form-field">
                {{ itemForm.itemName }}
                {{ itemForm.id }}
                {% if itemForm.itemName.errors %}
                  <div class="error">{{ itemForm.itemName.errors.0 }}</div>
                {% endif %}
              </div>
            </td>
            <td style="width: 15%;">
              <div class="form-field">
                {{ itemForm.rate }}
                {% if itemForm.rate.errors %}
                  <div class="error">{{ itemForm.rate.errors.0 }}</div>
                {% endif %}
              </div>
            </td>
            <td style="width: 15%;">
              <div class="form-field">
                {{ itemForm.gst }}
                {% if itemForm.gst.errors %}
                  <div class="error">{{ itemForm.gst.errors.0 }}</div>
                {% endif %}
              </div>
            </td>
            <td style="width: 15%;">
              <div class="form-field">
                {{ itemForm.qty }}
                {% if itemForm.qty.errors %}
                  <div class="error">{{ itemForm.qty.errors.0 }}</div>
                {% endif %}
              </div>
            </td>
            <td style="width: 5%;">
              {% if itemForm.instance.pk %}
                {{ itemForm.DELETE }}
              {% endif %}
              <button type="button" class="btn-destructive remove-row-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="1.2rem" height="1.2rem" viewBox="0 0 24 24"><path fill="currentColor" d="M2 17a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5h-2v5H4v-5H2m12.12-6.54l1.42 1.42L13.41 9l2.13 2.12l-1.42 1.42L12 10.41l-2.12 2.13l-1.42-1.42L10.59 9L8.46 6.88l1.42-1.42L12 7.59Z"/></svg>
              </button>
            </td>
          </tr>
          {% endfor %}

          <tr id="empty-form-template" style="display: none;">
            <td style="width: 50%;"><div class="form-field">{{ itemFormSet.empty_form.itemName }}</div></td>
            <td style="width: 15%;"><div class="form-field">{{ itemFormSet.empty_form.rate }}</div></td>
            <td style="width: 15%;"><div class="form-field">{{ itemFormSet.empty_form.gst }}</div></td>
            <td style="width: 15%;"><div class="form-field">{{ itemFormSet.empty_form.qty }}</div></td>
            <td style="width: 5%;"><button type="button" class="btn-secondary remove-row-button">
              <svg xmlns="http://www.w3.org/2000/svg" width="1.2rem" height="1.2rem" viewBox="0 0 24 24"><path fill="currentColor" d="M2 17a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-5h-2v5H4v-5H2m12.12-6.54l1.42 1.42L13.41 9l2.13 2.12l-1.42 1.42L12 10.41l-2.12 2.13l-1.42-1.42L10.59 9L8.46 6.88l1.42-1.42L12 7.59Z"/></svg>
            </button></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top: 1rem;">
      <button type="button" id="add-item-button" class="btn-secondary" style="width: 200px">Add New Item</button>
    </div>

    <div class="totals" style="text-align: right; margin-top: 2rem; font-weight: 500;">
      <p>Subtotal: <span id="subtotal-display">{{ invoiceInst.subTotal|default:"0.00" }}</span></p>
      <p>Total GST: <span id="gst-total-display">{{ invoiceInst.gstTotal|default:"0.00" }}</span></p>
      <p>Grand Total: <span id="grand-total-display">{{ invoiceInst.grandTotal|default:"0.00" }}</span></p>
    </div>

    <div style="margin-top: 1.5rem; display: flex; justify-content: center;">
      <button type="submit" class="btn-primary" style="width: 100%;">Update Invoice</button>
    </div>

  </form>
</div>

<script>
  const FORMSET_PREFIX = "{{ itemFormSet.prefix }}";
  const IS_EDIT_PAGE = true;
</script>
<script src="{% static 'script.js' %}" defer></script>
{% endblock %}
